<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KUKA LBR Robot Control</title>
  <style>
    :root{
      --bg:#0b0d10; --card:#111418; --muted:#9aa3ad; --text:#e6e9ef; --accent:#60a5fa;
    }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui,Segoe UI,Inter,Arial}
    #container3D{position:fixed; inset:0}
    #controls{
      position:fixed; top:14px; left:14px; z-index:10;
      background:rgba(17,20,24,.9); border:1px solid rgba(154,163,173,.2);
      border-radius:14px; padding:12px 12px 8px; max-width:340px; color:var(--text);
      backdrop-filter:saturate(1.1) blur(6px);
    }
    #controls h3{margin:0 0 8px; font-size:14px; color:var(--muted); font-weight:600}
    .control-group{display:flex; align-items:center; gap:8px; margin:8px 0}
    .control-group label{width:60px; font-size:13px; color:var(--muted)}
    input[type="range"]{width:200px}
    input[type="text"]{width:52px; border-radius:10px; border:1px solid rgba(154,163,173,.25); background:#0f1216; color:var(--text); padding:4px 6px}
    #end_effector_position{margin:10px 0 6px; font-weight:600; font-size:14px}
    #matrix_values p{margin:8px 0 4px; color:var(--muted); font-size:12px}
    #transformation_matrix{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
      display:grid; grid-template-columns:repeat(4,1fr); gap:4px; font-size:12px; background:#0f1216;
      border:1px dashed rgba(154,163,173,.25); border-radius:10px; padding:8px;
    }
    #transformation_matrix div{display:flex; align-items:center; justify-content:center; padding:4px 2px; color:#cdd5df}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0f1216; border:1px solid rgba(154,163,173,.25); font-size:12px; color:#cdd5df}
    .btn{cursor:pointer; border-radius:12px; background:#0f1216; color:var(--text); border:1px solid rgba(154,163,173,.25); padding:8px 10px}
    .btn.primary{background:linear-gradient(135deg,#79ffe1,#60a5fa); color:#0b0d10; border:none}
    .row{display:flex; gap:8px; margin:6px 0 10px}
  </style>
</head>
<body>
  <div id="container3D"></div>

  <div id="controls">
    <div class="row">
      <span class="pill">KUKA LBR iiwa-7</span>
      <button id="greet" class="btn primary">Greeting</button>
      <button id="reset" class="btn">Reset</button>
    </div>
    <h3>Joint control</h3>

    <div class="control-group">
      <label for="link_1">Link 1:</label>
      <input type="range" id="link_1" min="-170" max="170" value="0">
      <input type="text" id="link_1_text" value="0" title="Link 1 Value">
    </div>
    <div class="control-group">
      <label for="link_2">Link 2:</label>
      <input type="range" id="link_2" min="-120" max="120" value="0">
      <input type="text" id="link_2_text" value="0" title="Link 2 Value">
    </div>
    <div class="control-group">
      <label for="link_3">Link 3:</label>
      <input type="range" id="link_3" min="-170" max="170" value="0">
      <input type="text" id="link_3_text" value="0" title="Link 3 Value">
    </div>
    <div class="control-group">
      <label for="link_4">Link 4:</label>
      <input type="range" id="link_4" min="-120" max="120" value="0">
      <input type="text" id="link_4_text" value="0" title="Link 4 Value">
    </div>
    <div class="control-group">
      <label for="link_5">Link 5:</label>
      <input type="range" id="link_5" min="-170" max="170" value="0">
      <input type="text" id="link_5_text" value="0" title="Link 5 Value">
    </div>
    <div class="control-group">
      <label for="link_6">Link 6:</label>
      <input type="range" id="link_6" min="-120" max="120" value="0">
      <input type="text" id="link_6_text" value="0" title="Link 6 Value">
    </div>
    <div class="control-group">
      <label for="link_7_basic">Link 7:</label>
      <input type="range" id="link_7_basic" min="-175" max="175" value="0">
      <input type="text" id="link_7_basic_text" value="0" title="Link 7 Value">
    </div>

    <div id="end_effector_position">End Effector Position: (X: 0.00, Y: 0.00, Z: 0.00)</div>
    <div id="matrix_values">
      <p>Transformation Matrix:</p>
      <div id="transformation_matrix"></div>
    </div>
  </div>

  <!-- ES-module imports (same version across all) -->
  <script type="module">
    import * as THREE from "https://cdn.skypack.dev/three@0.129.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.skypack.dev/three@0.129.0/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "https://cdn.skypack.dev/three@0.129.0/examples/jsm/loaders/GLTFLoader.js";

    // --- Scene / renderer
    const scene = new THREE.Scene();
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById("container3D").appendChild(renderer.domElement);

    // --- Camera / controls
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(10,10,10);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.minDistance = 10;
    controls.maxDistance = 50;
    controls.rotateSpeed = 0.25;
    controls.maxPolarAngle = Math.PI/3;
    controls.minAzimuthAngle = -Math.PI/5;
    controls.maxAzimuthAngle =  Math.PI/10;

    // --- Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.9));
    const dl1 = new THREE.DirectionalLight(0xffffff, 1);   dl1.position.set( 500, 500,  500); scene.add(dl1);
    const dl2 = new THREE.DirectionalLight(0xffffff, 0.5); dl2.position.set(-500, 500,  500); scene.add(dl2);
    const dl3 = new THREE.DirectionalLight(0xffffff, 0.5); dl3.position.set( 500,-500,  500); scene.add(dl3);
    const dl4 = new THREE.DirectionalLight(0xffffff, 0.5); dl4.position.set( 500, 500, -500); scene.add(dl4);
    const dl5 = new THREE.DirectionalLight(0xffffff, 0.5); dl5.position.set(-500,-500, -500); scene.add(dl5);

    // Simple room hints
    const makeWall = (w,h,color)=>new THREE.Mesh(new THREE.PlaneGeometry(w,h), new THREE.MeshBasicMaterial({color,transparent:true,opacity:.25}));
    const floor = makeWall(20,20,0x60a5fa); floor.rotation.x = -Math.PI/2; floor.position.y = -10; scene.add(floor);
    const right = makeWall(20,20,0x059669); right.position.set(10,0,0); right.rotation.y = -Math.PI/2; scene.add(right);
    const back  = makeWall(20,20,0x2563eb); back.position.set(0,0,-10); scene.add(back);

    // --- Load robot (use your path)
    const MODEL_PATH = "assets/models/robot3.gltf";
    const loader = new GLTFLoader();

    // will hold {link_1: Object3D, ...}
    const links = {};
    let root;

    loader.load(MODEL_PATH, (gltf)=>{
      root = gltf.scene || gltf.scenes[0];
      root.traverse(o=>{ if (o.isMesh){ o.castShadow = o.receiveShadow = true; } });
      root.scale.set(10,10,10);
      root.position.set(0,-10,0);
      scene.add(root);

      // robust name mapping: find node OR parent named link_*
      const names = ["link_1","link_2","link_3","link_4","link_5","link_6","link_7","link_7_basic"];
      names.forEach(n=>{
        const node = root.getObjectByName(n);
        if (!node) return;
        // if this is a Mesh and its parent is the actual joint holder, prefer parent (common in GLTF)
        links[n] = (node.isMesh && node.parent) ? node.parent : node;
      });

      // if link_7 is present but link_7_basic UI is used, alias it
      if (!links["link_7_basic"] && links["link_7"]) links["link_7_basic"] = links["link_7"];

      updateLinkRotation();
      updateTransformationMatrix();
      updateEndEffectorPosition();
      autoGreeting(); // wave on load
    });

    // --- UI wiring
    const linkNames = ["link_1","link_2","link_3","link_4","link_5","link_6","link_7_basic"];

    function deg(v){ return THREE.MathUtils.degToRad(v); }

    function updateLinkRotation(){
      const v1 = parseFloat(document.getElementById("link_1").value);
      document.getElementById("link_1_text").value = v1;
      const v2 = parseFloat(document.getElementById("link_2").value);
      document.getElementById("link_2_text").value = v2;
      const v3 = parseFloat(document.getElementById("link_3").value);
      document.getElementById("link_3_text").value = v3;
      const v4 = parseFloat(document.getElementById("link_4").value);
      document.getElementById("link_4_text").value = v4;
      const v5 = parseFloat(document.getElementById("link_5").value);
      document.getElementById("link_5_text").value = v5;
      const v6 = parseFloat(document.getElementById("link_6").value);
      document.getElementById("link_6_text").value = v6;
      const v7 = parseFloat(document.getElementById("link_7_basic").value);
      document.getElementById("link_7_basic_text").value = v7;

      // Same axis convention as the repo: rotate around Y
      if (links["link_1"])       links["link_1"].rotation.y = deg(v1);
      if (links["link_2"])       links["link_2"].rotation.y = deg(v2);
      if (links["link_3"])       links["link_3"].rotation.y = deg(v3);
      if (links["link_4"])       links["link_4"].rotation.y = deg(v4);
      if (links["link_5"])       links["link_5"].rotation.y = deg(v5);
      if (links["link_6"])       links["link_6"].rotation.y = deg(v6);
      if (links["link_7_basic"]) links["link_7_basic"].rotation.y = deg(v7);

      updateTransformationMatrix();
      updateEndEffectorPosition();
    }

    // hook sliders + number inputs both ways
    for (const id of linkNames){
      const slider = document.getElementById(id);
      const box    = document.getElementById(id+"_text");
      slider.addEventListener('input', updateLinkRotation);
      box.addEventListener('input', ()=>{
        const v = parseFloat(box.value);
        if (!isNaN(v)){ slider.value = v; updateLinkRotation(); }
      });
    }

    // Reset + greeting
    document.getElementById('reset').onclick = ()=>{
      const defaults = {link_1:0,link_2:0,link_3:0,link_4:0,link_5:0,link_6:0,link_7_basic:0};
      for (const k of Object.keys(defaults)){
        document.getElementById(k).value = defaults[k];
        document.getElementById(k+"_text").value = defaults[k];
      }
      updateLinkRotation();
    };
    document.getElementById('greet').onclick = autoGreeting;

    // Greeting animation (simple timed keyframes)
// --- Greeting animation (custom pose and waving Link 4) ---
  function autoGreeting() {
    // Start from rest
    const startPose = {
      link_1: 0, link_2: 0, link_3: 0, link_4: 0,
      link_5: 0, link_6: 0, link_7_basic: 0
    };

    // Target pose from your screenshot
    const targetPose = {
      link_1: -170,
      link_2: -100,
      link_3: 61,
      link_4: -65,
      link_5: -70,
      link_6: -49,
      link_7_basic: -2
    };

    // We'll wave by oscillating link_4 from -120° to +120°
    const waveAmplitude = 120;
    const waveDuration = 5.0; // total seconds
    const waveSpeed = 0.5;    // cycles per second

    let start = performance.now();

    function step(now) {
      const t = (now - start) / 1000;
      if (t > waveDuration) return; // stop after full cycle

      // Linear interpolation to target pose
      const blend = Math.min(1, t / 1.0); // reach target in first second
      for (const id of linkNames) {
        const startVal = startPose[id] ?? 0;
        const targetVal = targetPose[id] ?? 0;
        const currentVal = startVal + (targetVal - startVal) * blend;
        document.getElementById(id).value = currentVal.toFixed(1);
        document.getElementById(id + "_text").value = currentVal.toFixed(1);
      }

      // Add waving motion to Link 4 after reaching pose
      if (t > 1.0) {
        const waveAngle = Math.sin((t - 1.0) * waveSpeed * Math.PI * 2) * waveAmplitude;
        document.getElementById("link_4").value = waveAngle.toFixed(1);
        document.getElementById("link_4_text").value = waveAngle.toFixed(1);
      }

      updateLinkRotation();
      requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
  }


    // --- Matrix utilities (same spirit as repo)
    function multiplyMatrices(a,b){
      const r=[[],[],[],[]];
      for(let i=0;i<4;i++){
        for(let j=0;j<4;j++){
          let s=0; for(let k=0;k<4;k++) s += a[i][k]*b[k][j];
          r[i][j]=s;
        }
      }
      return r;
    }
    function formatMatrix(m){ return m.flat().map(v=>`<div>${v.toFixed(2)}</div>`).join(''); }

    function updateTransformationMatrix(){
      // read angles from UI
      const angles = [
        +document.getElementById("link_1").value,
        +document.getElementById("link_2").value,
        +document.getElementById("link_3").value,
        +document.getElementById("link_4").value,
        +document.getElementById("link_5").value,
        +document.getElementById("link_6").value,
        +document.getElementById("link_7_basic").value,
      ];
      const mats = angles.map((theta,idx)=>{
        const r = THREE.MathUtils.degToRad(theta);
        const c = Math.cos(r), s = Math.sin(r);
        switch(idx){
          case 0: return [[ c,0,-s,0],[ s,0, c,0],[0,-1,0,34.0],[0,0,0,1]];
          case 1: return [[ c,0, s,0],[ s,0,-c,0],[0, 1,0, 0  ],[0,0,0,1]];
          case 2: return [[ c,0, s,0],[ s,0,-c,0],[0, 1,0,40.0],[0,0,0,1]];
          case 3: return [[ c,0,-s,0],[ s,0, c,0],[0,-1,0, 0  ],[0,0,0,1]];
          case 4: return [[ c,0,-s,0],[ s,0, c,0],[0,-1,0,40.0],[0,0,0,1]];
          case 5: return [[ c,0, s,0],[ s,0,-c,0],[0, 1,0, 0  ],[0,0,0,1]];
          case 6: return [[ c,-s,0,0],[ s, c,0,0],[0,0,0,12.6],[0,0,0,1]];
        }
      });
      let M = mats[0];
      for (let i=1;i<mats.length;i++) M = multiplyMatrices(M,mats[i]);
      document.getElementById("transformation_matrix").innerHTML = formatMatrix(M);
    }

    function updateEndEffectorPosition(){
      const ee = links["link_7_basic"] || links["link_7"];
      if (!ee) return;
      const p = new THREE.Vector3();
      ee.getWorldPosition(p);
      document.getElementById("end_effector_position").innerHTML =
        `End Effector Position: (X: ${p.x.toFixed(2)}, Y: ${p.y.toFixed(2)}, Z: ${p.z.toFixed(2)})`;
    }

    // --- Resize / animate
    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    (function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene,camera);
    })();
  </script>
</body>
</html>
